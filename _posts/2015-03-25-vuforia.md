---
layout: post
title:  "Using Argon.js with Vuforia"
date:   2015-03-25 13:35:15
short_description: "This tutorial shows you how to use Argon.js with Vuforia to do image recognition."
source_directory: tutorial3
---

Vuforia Tutorial
----------------

 
Vuforia is the image tracking system from Qualcomm (https://www.qualcomm.com/products/vuforia), which *argon.js* uses to recognize an image from a database and register graphics in relation to the image. This tutorial shows how to use an image from a database within *argon.js*. To use this feature effectively, you need to register with Vuforia and create your own database of images. When you register with Vuforia, you will receive a key to your database. This key guarantees that only the users of your applications can access your database. To use Vuforia in Argon3, you will need to insert an encrypted form of your key into your code.  

For the purposes of this tutorial example, however, we can use the standard "stones and chips" images provided by Vuforia without a developer's key.  On top of the stones image, we will place a box  that spins. On top of the chips images, we place an animated 3D graphic monster. (It looks something like a four-legged lizard  walking in place.)

## Main file (index.html)

Here is the html that goes into the body.  There is no "argon-immersive-context" div in this example. The body contains text that appears when the application is set to Page Mode: the text identifies the example for the user and provides a link to the stones and chips image. 

{% highlight html %}
<body style="background-color:rgba(255,255,255,0.7)"> 
 <div>  
<h2>Vuforia image tracking example</h2> 
<p>This example illustrates the use of Vuforia for image tracking. It is designed to work with the standard <a href="https://developer.vuforia.com/sites/default/files/sample-apps/targets/imagetargets_targets.pdf"> "stones and chips" Vuforia image</a>.</P> </div> 
</body>
{% endhighlight %}

## Code file (app.js)
We start with the standard setup. We are using the immersive context (the camera built into the device). We use webgl to render the scene, including the 3D graphic object that we will present. 

{% highlight js %}
 var options = THREE.Bootstrap.createArgonOptions( Argon.immersiveContext );
  options.renderer = { klass: THREE.WebGLRenderer };
  var three = THREE.Bootstrap( options );
{% endhighlight %}


We add light to our scene, because we will have a 3D object that needs to be lighted. These are three.js objects and methods, which you can find documented at http://threejs.org/docs/: 

{% highlight js %}
var light = new THREE.DirectionalLight( 0xffffff, 1 light.position.set( 0, -4, -4 ).normalize();
three.scene.add( light );
var pointLight = new THREE.PointLight( 0xffffff, 1.5, 1000 ) three.camera.add(pointLight);
{% endhighlight %}

 Tell *argon.js* that we require Vuforia for image tracking:
 
 {% highlight js %}
 Argon.immersiveContext.setRequiredCapabilities('Vuforia')
{% endhighlight %}

##The license key 
 
Then we initialize Vuforia with a license key. If the developer is using his or her own database, then the encrypted licenseKey would go here (see the end of this tutorial for how to do this). We put null and default to the Vuforia chips and stones image. 
{% highlight js %}
  Argon.Vuforia.initialize({ 
    licenseKey: null, 
    startCamera: true, 
  }) 
  .then(function(api) { 
    // load, activate, and use our dataSet 
    api.loadDataSetFromURL('dataset/StonesAndChips.xml').then(function (dataSet) { 
      dataSet.activate() 
      setupStonesContent(dataSet.trackables.stones) 
      setupChipsContent(dataSet.trackables.chips) 
    }).then(api.startObjectTracker) 
      .then(api.hintMaxSimultaneousImageTargets.bind(api, 2)) 
  })
{% endhighlight %}

## Setting up the trackables

This function sets up the content that will appear over the stones images. In this case we use *three.js* methods to construct and texture the box. This function shows the box when the stones image is recognized by Argon and removes the box when the image is lost (i.e. if the user moves the phone so that the camera can no longer see the image). When the box is first recognized, it spins 10 times, then stops. 

{% highlight js %}
  function setupStonesContent( stonesEntity ) { 
    // create an Object3D from the stones entity 
    var stones = three.argon.objectFromEntity(stonesEntity) 
    // create a box 
    var box = new THREE.Mesh(new THREE.BoxGeometry(50, 50, 50), new THREE.MeshNormalMaterial()) 
    box.position.y = 25 
    var boxSpin = 0 
    // add and spin the box when the stones trackable is found 
    stones.addEventListener('argon:found', function() { 
      stones.add(box) 
      boxSpin = 10 
    }) 
    // remove the box when the stones trackable is lost 
    stones.addEventListener('argon:lost', function() { 
      stones.remove(box) 
    }) 
    // animate the box 
    three.on('update', function() { 
      box.rotation.y += boxSpin * three.Time.delta 
      if (boxSpin > 0) boxSpin -= 10 * three.Time.delta 
      else boxSpin = 0 
    }) 
  } 
{% endhighlight %}

This function sets up the content to appear over the chips image. In this case we load a prebuilt model of a lizard. The function shows the lizard when the chips image is recognized by *argon.js* and removes it when the image is lost. 

{% highlight js %}
  function setupChipsContent( chipsEntity ) { 
    // create an Object3D from the chips entity 
    var chips = three.argon.objectFromEntity(chipsEntity) 
    // add the model when the chips trackable is found 
    chips.addEventListener('argon:found', function() { 
      getModel().then(function(model) { 
        chips.add(model) 
      }) 
    }) 
    // remove the model when the chips trackable is lost 
    chips.addEventListener('argon:lost', function() { 
      getModel().then(function(model) { 
        chips.remove(model) 
      }) 
    }) 
  }
{% endhighlight %}
 
This is the function that loads the lizard model, called by the setupChips function above. 

{% highlight js %}
  var modelPromise = getModel() 
  function getModel() { 
    return modelPromise = modelPromise || new Promise(function(resolve, reject) { 
      // load the model 
      var loader = new THREE.JSONLoader() 
      loader.load( 'monster.js', function ( geometry, materials ) { 
        materials[0].morphTargets = true 
        var faceMaterial = new THREE.MeshFaceMaterial( materials ) 
        var morphMesh = new THREE.MorphAnimMesh( geometry, faceMaterial ) 
        morphMesh.duration = 1000 
        morphMesh.time = 0 
        morphMesh.scale.set(0.1,0.1,0.1) 
        morphMesh.position.set(-100,0,0) 
        morphMesh.matrixAutoUpdate = false 
        morphMesh.updateMatrix() 
        // animate the model 
        three.on('update', function() { 
          morphMesh.updateAnimation( 1000 * three.Time.delta ) 
        }) 
        resolve(morphMesh) 
      }) 
    }) 
  }
{% endhighlight %}

## Testing the application

To test the completed application, you need to print out the stones and chips images or bring them up on a computer screen. Then launch the application on your phone and point it at the images. 

## Advanced: Creating an encrypted license key file

To use your own Vuforia targets, you must create your own Vuforia license key on their website, and use it when initializing Vuforia in argon.js.  

Since any file you put on a web server could potentially be copied by anyone with access to that server, argon.js requires that you store the license key in an encrypted JSON file.  The license should be in the *key* field in the JSON, as a string.

In addition, since you don't want anyone else to simply copy and that encrypted file, argon.js also requires you to store a set of url pattern's in the encrypted file, representing valid urls from which the key can be used. The url patterns should be in the *urls* field in the JSON, as an array of strings.

The format of the encrypted file is:  
{% highlight %}
{
   "key": " ---- YOUR VUFORIA LICENSE KEY HERE ---",
   "urls": ["^http://www.yourfullyqualifieddomain.com/", 
	  "^http[s]?://[A-Za-z0-9-.]*.yourdomainprefix.com/", 
	  "^http[s]?://[A-Za-z0-9-.]*.yourdomainprefix.com/partial/url/"]
}
{% endhighlight %}

To encrypt the file, you should encrypt it for the user *secure@argonjs.io*, using PGP.  There are both commercial and free PGP implementations that can be used;  we use [https://gpgtools.org] on MacOSX.  With GPGTools installed, fetch the public key for *secure@argonjs.io* using the "GPG Keychain" application, and then encrypt a file containing your JSON using *secure@argonjs.io* as the receipient.  Do not sign or encrypt the file with a password.

The easiest way to store the encrypted file is in a text tag in your HTML file, as follows:
{% highlight %}
<script id="license" type="text/plain">-----BEGIN PGP MESSAGE-----
Comment: GPGTools - https://gpgtools.org

hQIMA47tt+RhMWHyARAAytTjlCY9COkseZb/73Z5g9m8nBuuX2XPlg/RlUHS15UD
DTPP5X4lrNGSkG8NW8ET+KQjIao1DVCehG9UTeK7DV0ShLem5BmxLkmo6ihiXpr/
QK7hqykkmf3A+n5xHzx7dmfLUny5OcFjfUN16WRHGvkm7WWxGpDL/ukcpuHJuL9g
G96EX+FQZESUK8ScC5Hboh7bDVozjAsVqsb3sSivQlenrjTWZX80aaGU6Sef9lfF
m2S/I144qK15L/drylt7XacPZ+yCuKZ3NhpUnsI2d76iPsf3zWzump0xGXU1b9M9
ZwUFOjBxOQsz0i0QiIZXLRnu3soIeL3SoXrlJwD1c4oyLtR2AFeJ4ZdMqs+uNswf
mk0Y0vtkkmfWzZyl44tqkMvd5m/O2OgPvPH/Oh4f2LoCwDl0SWtNMfuscmh5ryIX
7FPZs47x/QrdzbzqLhs73xj8LLCtVHaMYehaf8kf5QEqRCZdDvk73/zI3XN0nkDU
Iu8G08AdfPDiLeyz/OoUEbnH+ph8tY1/+gZ5BH47VMUaRjnUSdAsMdczPyh7L8WI
OG8SU7aj+7S8NTBmu69OIBoq77QWl4zCSisnPzfNfaDoax4OOCuwz3TxETVlr9Ww
f51yeLrR+RqWDonrGNJ4RuuE8ZQVuojBkBdlaHYEPn6+Fr7efQkGaLew7efCQjfS
wPwBu650+pihgPELveEyqXar68BHl+CMR4RpGGQOp6GAoKMcZpUAed8m0Tg5ZU2y
DUj9KPrQ1bX6fyxW2RgdJmIGi6926lv3sL93xuXKPBmcA+2bIqPw0vmELG2NgrJQ
7CYd80IDWzBmngIkh8kFEZrkL+RSciJ9/NEauVBrNxFNUYGTY6l1f9AyHqmwschd
G9FnldNskH8UDtowbDHcz0OoHYnP/TLI9PQft1aHFA/WBg6oYv2Nrnb1/GdYE5JE
xpgganPTMcxPs5Ch6XVPIRIZsCJ9aVqSmUpgCEECoDWmvVLABN5EoTHr3rIedSqN
/7F1o3bmXrcNV3AqlLQcU/RXeaKxeUPAsLJ99ELb7dZO53pLaUAeqQzLtTO8t/Gd
f7Y7uUVl6gRqyBbWaXpsvhiYb1aAsN8ddOo2RYKDQ/YNF5+A2H0cGFCDItK70DhV
nXb5GpWDP+6pioBIDbBWDebixrqh5Q/SC+C8bv7wyA+r1GyyCUX6rBB3b9P5sPiv
oPYi64cpRfve6rkR4yDJhSQRTFsFcE9MHotWt1NeNSSURoujC2JIcQCoK4tYn+xr
IDLFqt+xPYz/zzgfuAA=
=kqis
-----END PGP MESSAGE-----
</script>
{% endhighlight %}
Do not put any extra space at the beginning or end of the text tag, and to not reformat the file.

Now, to use this key in your code, get the contents of the HTML text element and pass it to the *Argon.Vuforia.initialize* method as the *encryptedLicenseData* parameter (instead of passing *null* to *licenseKey* above). 
{% highlight js %}
  var encryptedData = document.getElementById("license").text;

  // initialize Vuforia with our licencse key
  Argon.Vuforia.initialize({
     encryptedLicenseData: encryptedData,
     startCamera: true,
  })
{% endhighlight %}